<div class="mx-auto space-y-10 animate-fadeIn">

    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-slate-800">Create Exam</h1>
            <p class="text-gray-500 text-sm mt-1">
                Set up a new theory exam with structured questions and subparts.
            </p>
        </div>
    </div>

    <!-- Exam Form -->
    <form [formGroup]="examForm" (ngSubmit)="onSubmit()" class="space-y-8">

        <!-- Exam Details -->
        <div class="bg-white shadow-md rounded-xl p-6 border border-gray-100 space-y-6">
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Course Title</label>
                    <input formControlName="title" type="text" placeholder="e.g. Object-Oriented Programming"
                        class="w-full border rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500" />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Course Code</label>
                    <input formControlName="courseCode" type="text" placeholder="e.g. CSC 204"
                        class="w-full border rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500" />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Examiner Name</label>
                    <input formControlName="examinerName" type="text" placeholder="e.g. Dr. Smith"
                        class="w-full border rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500" />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Exam Date</label>
                    <input formControlName="examDate" type="date" placeholder="e.g. dd/mm/yyyy"
                        class="w-full border rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500" />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Duration (minutes)</label>
                    <input formControlName="duration" type="number" placeholder="e.g. 60"
                        class="w-full border rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500" />
                </div>
            </div>

            <!-- Instructions -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Instructions</label>
                <div class="ngx-editor-container border rounded-lg">
                    <ngx-editor-menu [editor]="instructionsEditor" [toolbar]="toolbar">
                    </ngx-editor-menu>

                    <ngx-editor [editor]="instructionsEditor" formControlName="instructions"
                        placeholder="Enter exam instructions..." outputFormat="html">
                    </ngx-editor>
                </div>
            </div>
        </div>

        <!-- Questions -->
        <div class="space-y-6">
            <h2 class="text-xl font-semibold text-gray-800">Questions</h2>

            <div formArrayName="questions" class="space-y-6">
                @for (q of questions.controls; track trackByIndex($index); let qIndex = $index) {

                <div [formGroupName]="qIndex" class="bg-white border rounded-xl p-6 space-y-5">

                    <!-- Question header -->
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <label class="font-medium">Question {{ qIndex + 1 }}</label>
                        </div>

                        @if (questions.length > 1) {
                        <button type="button" (click)="removeQuestion(qIndex)" class="text-red-500 text-sm">
                            Remove Question
                        </button>
                        }
                    </div>

                    <!-- Sub-questions -->
                    <div formArrayName="subQuestions" class="space-y-5 border-l-4 border-blue-100 pl-4">

                        @for (s of getSubQuestions(qIndex).controls; track trackByIndex($index); let sIndex = $index) {

                        <div [formGroupName]="sIndex" class="bg-gray-50 p-4 rounded-lg space-y-4">

                            <div class="flex justify-between items-center">
                                <label class="font-medium text-gray-700">
                                    Sub-question
                                    ({{ s.get('label')?.value || '?' }})
                                </label>

                                @if (getSubQuestions(qIndex).length > 1) {
                                <button type="button" (click)="removeSubQuestion(qIndex, sIndex)"
                                    class="text-red-500 text-xs">
                                    Remove
                                </button>
                                }
                            </div>

                            <div class="grid gap-4">

                                <!-- Label -->
                                <div class="md:w-32">
                                    <label class="text-sm">Label</label>
                                    <input formControlName="label" placeholder="a"
                                        class="w-full border rounded-lg px-3 py-1.5" />
                                </div>

                                <!-- Question Text -->
                                <div>
                                    <label class="text-sm">Question Text</label>
                                    @if (getSubQuestionEditor(qIndex, sIndex); as editor) {
                                    <div class="ngx-editor-container border rounded-lg">
                                        <ngx-editor-menu [editor]="editor" [toolbar]="toolbar"></ngx-editor-menu>
                                        <ngx-editor [editor]="editor" formControlName="questionText"
                                            placeholder="Type your question here..." outputFormat="html">
                                        </ngx-editor>
                                    </div>
                                    }
                                </div>

                                <!-- Marking Guide -->
                                <div>
                                    <label class="text-sm">Marking Guide / Expected Answer</label>
                                    @if (getSubQuestionMarkingEditor(qIndex, sIndex); as mgEditor) {
                                    <div class="ngx-editor-container border rounded-lg">
                                        <ngx-editor-menu [editor]="mgEditor" [toolbar]="toolbar"></ngx-editor-menu>
                                        <ngx-editor [editor]="mgEditor" formControlName="markingGuide"
                                            placeholder="Provide marking guide..." outputFormat="html">
                                        </ngx-editor>
                                    </div>
                                    }
                                </div>

                                <!-- Marks -->
                                <div class="md:w-32">
                                    <label class="text-sm">Marks</label>
                                    <input formControlName="marks" type="number" placeholder="5"
                                        class="w-full border rounded-lg px-3 py-1.5" />
                                </div>

                            </div>
                        </div>
                        }

                        <button type="button" (click)="addSubQuestion(qIndex)" class="text-blue-600 text-sm mt-3">
                            + Add Sub-question
                        </button>
                    </div>
                </div>
                }
            </div>

            <button type="button" (click)="addQuestion()" class="bg-gray-100 px-5 py-2 rounded-lg">
                + Add Question
            </button>
        </div>

        <!-- Submit -->
        <div class="pt-6 border-t">
            <button type="submit" [disabled]="examForm.invalid"
                class="bg-blue-600 text-white px-6 py-2.5 rounded-lg disabled:bg-gray-400">
                Save Exam
            </button>
        </div>
    </form>
</div>